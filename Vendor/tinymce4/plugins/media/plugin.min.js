tinymce.PluginManager.add("media",function(c,w){function s(a){return-1!=a.indexOf(".mp3")?"audio/mpeg":-1!=a.indexOf(".wav")?"audio/wav":-1!=a.indexOf(".mp4")?"video/mp4":-1!=a.indexOf(".webm")?"video/webm":-1!=a.indexOf(".ogg")?"video/ogg":-1!=a.indexOf(".swf")?"application/x-shockwave-flash":""}function q(a){var b=c.settings.media_scripts;if(b)for(var g=0;g<b.length;g++)if(-1!==a.indexOf(b[g].filter))return b[g]}function t(){function a(){c.focus(!0);var a=0;"undefined"!==typeof c.settings.filemanager_type&&
	c.settings.filemanager_type&&(a=!0===$.isNumeric(c.settings.filemanager_type)&&0<c.settings.filemanager_type&&2>=c.settings.filemanager_type?c.settings.filemanager_type:"image"==c.settings.filemanager_type?1:"media"==c.settings.filemanager_type?2:0);var b=c.settings.file_browser_url;b.match(/\?/g)?(b.match(/\?/g)&&b.match(/&/g),b+="&type="+a+"&lang="+c.settings.language):b+="?type="+a+"&lang="+c.settings.language;g=c.windowManager.open({title:"Filemanager",file:b,width:860,height:570,inline:1,resizable:!0,
	maximizable:!0,buttons:[{text:"Insert",onclick:function(){var a=c.windowManager.getWindows()[0],b=a.getContentWindow().LoremIpsumDialog.insert(),g=c.selection.getNode();c.selection.select(g);g.innerHTML=b;c.undoManager.transact(function(){c.setContent(c.getContent({raw:!0}))});a.close()}},{text:"Close",onclick:"close"}]})}function b(a){var b,c,e,d;b=g.find("#width")[0];c=g.find("#height")[0];e=b.value();d=c.value();g.find("#constrain")[0].checked()&&m&&h&&e&&d&&(a.control==b?(d=Math.round(e/m*d),
	c.value(d)):(e=Math.round(d/h*e),b.value(e)));m=e;h=d}var g,m,h,e,d=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source"}];"string"===typeof c.settings.media_browser_url&&""!=c.settings.media_browser_url&&(d=[{type:"container",layout:"flex",classes:"combobox has-open",label:"Source",direction:"row",items:[{name:"src",type:"textbox",filetype:"media",size:65,classes:"media_"+c.id,autofocus:!0},{name:"upl_img",type:"button",classes:"btn open",icon:"browse",onclick:a,
	tooltip:"Upload Media"}]}]);!1!==c.settings.media_alt_source&&d.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"});!1!==c.settings.media_poster&&d.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"});!1!==c.settings.media_dimensions&&d.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:b},{type:"label",text:"x"},{name:"height",type:"textbox",
	maxLength:3,size:3,onchange:b},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]});e=x(c.selection.getNode());m=e.width;h=e.height;g=c.windowManager.open({title:"Insert/edit video",data:e,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){e=r(this.next().find("#embed").value());this.fromJSON(e)},items:d},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(u(this.parent().toJSON()))},
	items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},{id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:y(),multiline:!0,label:"Source"}]}],onSubmit:function(){c.insertContent(u(this.toJSON()))}})}function y(){if(c.selection.getNode().getAttribute("data-mce-object"))return c.selection.getContent()}function u(a){var b="";if(!a.source1&&(tinymce.extend(a,r(a.embed)),!a.source1))return"";a.source2||(a.source2="");a.poster||(a.poster="");a.source1=c.convertURL(a.source1,
	"source");a.source2=c.convertURL(a.source2,"source");a.source1mime=s(a.source1);a.source2mime=s(a.source2);a.poster=c.convertURL(a.poster,"poster");a.flashPlayerUrl=c.convertURL(w+"/moxieplayer.swf","movie");if(a.embed)b=v(a.embed,a,!0);else{tinymce.each(z,function(b){var c,g,d;if(c=b.regex.exec(a.source1)){d=b.url;for(g=0;c[g];g++)d=d.replace("$"+g,function(){return c[g]});a.source1=d;a.type=b.type;a.width=a.width||b.w;a.height=a.height||b.h}});var g=q(a.source1);g&&(a.type="script",a.width=g.width,
	a.height=g.height);a.width=a.width||300;a.height=a.height||150;tinymce.each(a,function(b,g){a[g]=c.dom.encode(b)});"iframe"==a.type?b+='<iframe src="'+a.source1+'" width="'+a.width+'" height="'+a.height+'"></iframe>':"application/x-shockwave-flash"==a.source1mime?(b+='<object data="'+a.source1+'" width="'+a.width+'" height="'+a.height+'" type="application/x-shockwave-flash">',a.poster&&(b+='<img src="'+a.poster+'" width="'+a.width+'" height="'+a.height+'" />'),b+="</object>"):b=-1!=a.source1mime.indexOf("audio")?
	c.settings.audio_template_callback?c.settings.audio_template_callback(a):b+('<audio controls="controls" src="'+a.source1+'">'+(a.source2?'\n<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</audio>"):"script"==a.type?b+('<script src="'+a.source1+'">\x3c/script>'):c.settings.video_template_callback?c.settings.video_template_callback(a):'<video width="'+a.width+'" height="'+a.height+'"'+(a.poster?' poster="'+a.poster+'"':"")+' controls="controls">\n<source src="'+
	a.source1+'"'+(a.source1mime?' type="'+a.source1mime+'"':"")+" />\n"+(a.source2?'<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</video>"}return b}function r(a){var b={};(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(a,c){b.source1||"param"!=a||(b.source1=c.map.movie);if("iframe"==a||"object"==a||"embed"==a||"video"==a||"audio"==a)b.type||(b.type=a),b=tinymce.extend(c.map,b);if("script"==a){var h=
	q(c.map.src);if(!h)return;b={type:"script",source1:c.map.src,width:h.width,height:h.height}}"source"==a&&(b.source1?b.source2||(b.source2=c.map.src):b.source1=c.map.src);"img"!=a||b.poster||(b.poster=c.map.src)}})).parse(a);b.source1=b.source1||b.src||b.data;b.source2=b.source2||"";b.poster=b.poster||"";return b}function x(a){return a.getAttribute("data-mce-object")?r(c.serializer.serialize(a,{selection:!0})):{}}function v(a,b,c){function m(a,b){var c,d,g,e;for(c in b)if(g=""+b[c],a.map[c])for(d=
																																																																																																																														   a.length;d--;)e=a[d],e.name==c&&(g?(a.map[c]=g,e.value=g):(delete a.map[c],a.splice(d,1)));else g&&(a.push({name:c,value:g}),a.map[c]=g)}var h=new tinymce.html.Writer,e=0,d;(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(a){h.comment(a)},cdata:function(a){h.cdata(a)},text:function(a,b){h.text(a,b)},start:function(a,f,k){switch(a){case "video":case "object":case "embed":case "img":case "iframe":m(f,{width:b.width,height:b.height})}if(c)switch(a){case "video":m(f,
	{poster:b.poster,src:""});b.source2&&m(f,{src:""});break;case "iframe":m(f,{src:b.source1});break;case "source":e++;if(2>=e&&(m(f,{src:b["source"+e],type:b["source"+e+"mime"]}),!b["source"+e]))return;break;case "img":if(!b.poster)return;d=!0}h.start(a,f,k)},end:function(a){if("video"==a&&c)for(var f=1;2>=f;f++)if(b["source"+f]){var k=[];k.map={};e<f&&(m(k,{src:b["source"+f],type:b["source"+f+"mime"]}),h.start("source",k,!0))}b.poster&&"object"==a&&c&&!d&&(f=[],f.map={},m(f,{src:b.poster,width:b.width,
	height:b.height}),h.start("img",f,!0));h.end(a)}},new tinymce.html.Schema({}))).parse(a);return h.getContent()}var z=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",
	w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"'}];c.on("ResolveName",function(a){var b;1==a.target.nodeType&&(b=a.target.getAttribute("data-mce-object"))&&(a.name=b)});c.on("preInit",function(){var a=c.schema.getSpecialElements();tinymce.each(["video","audio","iframe","object"],function(b){a[b]=RegExp("</"+b+"[^>]*>","gi")});c.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");var b=c.schema.getBoolAttrs();
	tinymce.each(["webkitallowfullscreen","mozallowfullscreen","allowfullscreen"],function(a){b[a]={}});c.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(a,b){for(var h=a.length,e,d,l,f,k,n,p;h--;){d=a[h];if("script"==d.name&&(p=q(d.attr("src")),!p))continue;l=new tinymce.html.Node("img",1);l.shortEnded=!0;p&&(p.width&&d.attr("width",p.width.toString()),p.height&&d.attr("height",p.height.toString()));n=d.attributes;for(e=n.length;e--;)if(f=n[e].name,k=n[e].value,"width"!==f&&"height"!==
		f&&"style"!==f){if("data"==f||"src"==f)k=c.convertURL(k,f);l.attr("data-mce-p-"+f,k)}if(e=d.firstChild&&d.firstChild.value)l.attr("data-mce-html",escape(e)),l.firstChild=null;l.attr({width:d.attr("width")||"300",height:d.attr("height")||("audio"==b?"30":"150"),style:d.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":b,"class":"mce-object mce-object-"+b});d.replace(l)}});c.serializer.addAttributeFilter("data-mce-object",function(a,b){for(var c=a.length,e,d,l,f,k;c--;){e=a[c];k=e.attr(b);
		d=new tinymce.html.Node(k,1);"audio"!=k&&"script"!=k&&d.attr({width:e.attr("width"),height:e.attr("height")});d.attr({style:e.attr("style")});f=e.attributes;for(l=f.length;l--;){var n=f[l].name;0===n.indexOf("data-mce-p-")&&d.attr(n.substr(11),f[l].value)}"script"==k&&d.attr("type","text/javascript");if(l=e.attr("data-mce-html"))f=new tinymce.html.Node("#text",3),f.raw=!0,f.value=unescape(l),d.append(f);e.replace(d)}})});c.on("ObjectSelected",function(a){var b=a.target.getAttribute("data-mce-object");
	"audio"!=b&&"script"!=b||a.preventDefault()});c.on("objectResized",function(a){var b=a.target,c;b.getAttribute("data-mce-object")&&(c=b.getAttribute("data-mce-html"))&&(c=unescape(c),b.setAttribute("data-mce-html",escape(v(c,{width:a.width,height:a.height}))))});c.addButton("media",{tooltip:"Insert/edit video",onclick:t,stateSelector:["img[data-mce-object=video]","img[data-mce-object=iframe], img[data-mce-object=object]"]});c.addMenuItem("media",{icon:"media",text:"Insert video",onclick:t,context:"insert",
	prependToContext:!0})});